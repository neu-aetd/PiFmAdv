name: Compile PiFmAdv for Raspberry Pi 4 (Bullseye) - Manual

on:
  workflow_dispatch: # 允许手动触发工作流

jobs:
  build:
    runs-on: ubuntu-latest # 使用最新的 Ubuntu 运行环境

    steps:
    - name: Checkout repository
      uses: actions/checkout@main # 检出代码到工作区

    - name: Install necessary libraries on runner
      run: |
        sudo apt-get update && sudo apt-get upgrade -y
        sudo apt-get install -y libc6-dev

    - name: Install QEMU and dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y qemu-user-static binfmt-support

    - name: Set up QEMU
      run: |
        docker run --rm --privileged multiarch/qemu-user-static --reset

    - name: Run Raspberry Pi OS Bullseye container
      run: |
        docker run --rm --platform linux/arm64 -v $(pwd):/workdir -w /workdir arm64v8/debian:bullseye /bin/bash -c "
          apt-get update &&
          apt-get install -y build-essential libsndfile1-dev libsoxr-dev &&
          cd src &&
          make || exit 1
        "

    - name: Check compiled binary
      run: |
        file src/pi_fm_adv

    - name: Rename and archive compiled binary
      run: |
        cd src
        DATE=$(date +%Y-%m-%d)
        mv pi_fm_adv pi_fm_adv_${DATE}
        echo "date=${DATE}" >> $GITHUB_ENV

    - name: Upload compiled binary as artifact
      uses: actions/upload-artifact@main
      with:
        name: pi_fm_adv_${{ env.date }}
        path: src/pi_fm_adv_${{ env.date }}
